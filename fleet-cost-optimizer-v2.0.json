{"name": "Fleet Cost Optimizer", "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide", "version": "2.0", "items": [{"url": "audit.html", "path": "ActivityLink", "menuName": {"en": "Fleet Cost Optimizer"}}], "files": {"audit.html": "<!DOCTYPE html><html><head><meta charset='utf-8'><style>\n.rw{padding:3px 8px 3px 0;vertical-align:top;color:#2d3748;font-weight:600;font-size:12px}\n.re{padding:3px 8px 3px 0;vertical-align:top;color:#e53e3e;font-weight:600;font-size:12px}\n.ac{background:#fff;border:1px solid #e2e8f0;border-radius:0 8px 8px 0;padding:16px 20px;margin-bottom:14px;font-size:13px;line-height:1.6;box-shadow:0 1px 3px rgba(0,0,0,.06)}\n.ab{background:#fff8f0;border-left:4px solid #ed8936;padding:12px;margin-bottom:10px;border-radius:0 6px 6px 0;font-size:13px}\n.ay{background:#fffbeb;border-left:4px solid #ecc94b;padding:12px;margin-bottom:10px;border-radius:0 6px 6px 0;font-size:13px}\n.az{background:#ebf8ff;border-left:4px solid #3182ce;padding:12px;margin-bottom:10px;border-radius:0 6px 6px 0;font-size:13px}\n.vc{background:#fff;border:1px solid #dee2e6;border-radius:6px;padding:16px;margin-bottom:16px}\n.gp{background:rgba(255,255,255,0.1);padding:10px;border-radius:6px;font-size:12px}\n.tc{text-align:center}.tg{text-align:center;color:#38a169}.tr{text-align:center;color:#e53e3e}.ty{text-align:center;color:#fbd38d}\n.si{font-size:13px;color:#4a5568;line-height:1.6;margin:0 0 14px;padding:10px 14px;background:#f7fafc;border-radius:6px;border-left:3px solid #cbd5e0}\n@media print{body{background:#fff!important;font-size:11px}.ac{break-inside:avoid;box-shadow:none;border:1px solid #ccc}#header,.btn{display:none!important}.card{break-inside:avoid;box-shadow:none!important}}\n</style></head>\n<body style='background:#f8f9fa;margin:0;padding:0;font-family:sans-serif;'>\n<div id='header' style='background:#1a237e;color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.2);'>\n<div><h1 style='margin:0;font-size:24px;'>Fleet Cost Optimizer <small style='font-size:12px;opacity:0.6;'>v2.0</small></h1>\n<p style='margin:0;opacity:0.8;font-size:14px;'>Executive Fleet Intelligence Report</p></div>\n<div><button id='run-btn' style='background:#28a745;color:white;border:none;padding:10px 25px;border-radius:4px;font-weight:bold;cursor:pointer;'>Run Audit</button>\n<button id='debug-btn' style='background:transparent;color:rgba(255,255,255,0.4);border:1px solid rgba(255,255,255,0.2);padding:10px 15px;border-radius:4px;cursor:pointer;font-size:11px;margin-left:8px;display:none;'>Debug</button></div></div>\n<div id='main-container' class='container-fluid p-4' style='max-width:1200px;margin:auto;'>\n<div id='status-msg' style='display:none;' class='alert alert-info'><span id='status-text'>Analyzing...</span></div>\n<div id='results-content' style='display:none;'>\n<div id='exec-summary-anchor'></div><div id='sustainability-anchor'></div><div id='monthly-trend-anchor'></div>\n<div class='card mb-4 shadow-sm text-center'><div class='card-body'>\n<h5 class='text-muted text-uppercase small'>Total Optimization Opportunity (Current Month)</h5>\n<h1 id='total-waste-text' style='color:#dc3545;font-weight:bold;font-size:48px;margin:10px 0;'>$0 CAD</h1>\n<p id='annual-text' class='text-secondary mb-1'></p></div></div>\n<div class='si'>\ud83d\udcca <b>What We Found:</b> <span id='fleet-size-text'>50</span> vehicles analyzed over <span id='data-span-text'>22</span> days. Four categories of recoverable cost below, ranked by impact. Each links to a specific action in the Roadmap.</div>\n<div class='row' id='findings-grid'></div><div id='action-plan-anchor'></div>\n<div id='evidence-report' style='display:none;'></div>\n<div class='mt-4'><button class='btn btn-outline-secondary btn-sm w-100' type='button' data-bs-toggle='collapse' data-bs-target='#methodBox'>Methodology &amp; Sources</button></div>\n<div class='collapse mt-2' id='methodBox'><div class='card card-body small text-muted'>\n<p><b>Costs:</b> Ghost=$800/mo (lease+ins). Idle=$4.30/hr (3.5L/hr\u00d7$1.23/L). Risk=2\u00d7avg events. Breakdown=3+ mech faults.</p>\n<p><b>Benchmarks:</b> Idle &lt;15% (NRCan). Safety 20-40 events/vehicle/yr. Lease $800/mo (DesRosiers 2025). Idle fuel 2.5-4.0 L/hr (NRCan), using 3.5. CO\u2082 2.68kg/L diesel (ECCC). Proactive $400 vs breakdown $1,200-$3,500 (CAA).</p>\n<p><b>Regulatory:</b> Clean Fuel Regs (SOR/2022-140). OBPS under GGPPA. Net-Zero Accountability Act (S.C. 2021, c.22). NRCan FleetSmart. ISSB S2 via CSA.</p>\n</div></div></div></div>\n<script>\nwindow.onerror=function(m,s,l,c,e){var el=document.getElementById('status-msg');if(el){el.style.display='block';document.getElementById('status-text').textContent='JS Error: '+m+' (line '+l+')';document.getElementById('status-text').style.color='red'}return false};\nvar link=document.createElement('link');link.rel='stylesheet';link.href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css';document.head.appendChild(link);\nvar scr=document.createElement('script');scr.src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js';document.head.appendChild(scr);\nfunction pD(d){if(!d)return 0;var days=0,tp=d;if(d.indexOf('.')>-1){var p=d.split('.');days=parseInt(p[0])||0;tp=p[1]}var t=tp.split(':');return(days*24)+(parseInt(t[0])||0)+(parseInt(t[1])||0)/60+(parseInt(t[2])||0)/3600}\nfunction fD(d){var h=pD(d);if(h>720)return'ongoing';if(h<.01)return'0m';var m=Math.round(h*60),hr=Math.floor(m/60),mn=m%60;return hr>0?hr+'h '+mn+'m':mn+'m'}\nfunction fC(n){return Math.round(n).toLocaleString()+' CAD'}\nfunction cD(s){return s.replace('Diagnostic','').replace('Id','').replace(/([A-Z])/g,' $1').trim()}\nfunction mL(ym){var p=ym.split('-'),mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return mn[parseInt(p[1])-1]+' '+p[0].substring(2)}\nfunction sOf(m){return(m>=11||m<=2)?'winter':(m>=3&&m<=5)?'spring':(m>=6&&m<=8)?'summer':'fall'}\nfunction isN(n){return n.indexOf('accelerometer')>-1||n.indexOf('disabled')>-1||n.indexOf('telematics')>-1||n.indexOf('accident')>-1||n.indexOf('collision')>-1}\nfunction sC(s){return s==='winter'?'#3182ce':s==='spring'?'#38a169':s==='summer'?'#d69e2e':'#dd6b20'}\nfunction sI(s){return s==='winter'?'\u2744\ufe0f':s==='spring'?'\ud83c\udf31':s==='summer'?'\u2600\ufe0f':'\ud83c\udf42'}\nvar _dd={};\ngeotab.addin['fleet-waste-finder']=function(){return{initialize:function(api,s,cb){\ndocument.getElementById('run-btn').onclick=function(){runAudit(api)};\nvar db=document.getElementById('debug-btn');db.style.display='inline-block';\ndb.onclick=function(){var d=_dd;if(!d.dv){alert('Run audit first.');return}\nvar o='=== FCO v2.0 ===\\nDev:'+d.dv+' Tr:'+d.tr+' Exc:'+d.ex+' Fl:'+d.fl+'\\nSpan:'+d.sp+'d Mo:'+d.mo+'\\nIdle:'+d.ih.toFixed(1)+'h Dr:'+d.dh.toFixed(1)+'h Rate:'+d.ir.toFixed(1)+'%\\nGh:'+d.gh+' Id:'+d.ic+' Rk:'+d.hr+' Mt:'+d.mt+' $:'+d.tw+'\\n';\nif(d.mk)d.mk.forEach(function(k){o+=k+':idle='+d.mi[k].toFixed(1)+'h\\n'});\nvar w=window.open('','_blank','width=600,height=400');w.document.write('<pre style=\"font-size:12px;padding:20px\">'+o+'</pre>')};cb()}}};\nfunction runAudit(api){\nvar st=document.getElementById('status-msg'),tx=document.getElementById('status-text'),rb=document.getElementById('run-btn');\nst.style.display='block';rb.disabled=true;tx.style.color='';tx.textContent='Pulling 12 months of data...';\nvar d365=new Date();d365.setDate(d365.getDate()-365);\napi.multiCall([['Get',{typeName:'Device'}],['Get',{typeName:'Trip',search:{fromDate:d365.toISOString()}}],['Get',{typeName:'ExceptionEvent',search:{fromDate:d365.toISOString()}}],['Get',{typeName:'Rule'}],['Get',{typeName:'FaultData',search:{fromDate:d365.toISOString()}}]],function(r){\ntx.textContent='Processing '+r[1].length+' trips...';\nsetTimeout(function(){try{proc(r[0],r[1],r[2],r[3],r[4]);st.style.display='none';rb.disabled=false;document.getElementById('results-content').style.display='block'}catch(err){rb.disabled=false;tx.textContent='ERROR: '+err.message;tx.style.color='red';console.error(err)}},50)},function(e){rb.disabled=false;tx.textContent='API Error: '+e;tx.style.color='red'})}\nfunction proc(devs,trips,exs,rules,faults){\nvar dm={},ear=new Date(),rm={},ni={};\nrules.forEach(function(r){rm[r.id]=r.name});\ndevs.forEach(function(d){ni[d.name]=d.id;dm[d.id]={id:d.id,nm:d.name,ft:null,ad:{},ih:0,dh:0,ec:0,mf:[],af:[],tr:[],ex:[],dk:0}});\nvar ms={};\ntrips.forEach(function(t){var d=dm[t.device.id];if(!d)return;var dt=new Date(t.start);\nd.tr.push(t);if(!d.ft||dt<d.ft)d.ft=dt;if(dt<ear)ear=dt;\nd.ad[t.start.substring(0,10)]=true;\nvar ih=pD(t.idlingDuration),dh=pD(t.drivingDuration);d.ih+=ih;d.dh+=dh;\nif(t.distance)d.dk+=t.distance;\nvar ym=t.start.substring(0,7);if(!ms[ym])ms[ym]={idle:0,drv:0,trips:0,co2:0,devs:{}};\nms[ym].idle+=ih;ms[ym].drv+=dh;ms[ym].trips++;ms[ym].co2+=ih*3.5*2.68;ms[ym].devs[t.device.id]=true});\nvar now=new Date(),span=Math.floor((now-ear)/864e5)||1,isE=true;\ndevs.forEach(function(d){var s=dm[d.id];if(s.dk>0)isE=false;var uk=s.dk>0?s.dk:((s.dh||0)*40);s.ek=uk;s.dkm=span>0?(uk/span):0});\nexs.forEach(function(e){var d=dm[e.device.id];if(d){d.ex.push(e);d.ec++}});\nfaults.forEach(function(f){var d=dm[f.device&&f.device.id];if(!d)return;var di=f.diagnostic&&f.diagnostic.id;if(!di||typeof di!=='string')return;d.af.push(f);var n=di;if((/(Warning|Malfunction|Fault|Engine)/i.test(n)||f.amberWarningLamp)&&!/Disabled|Accelerometer/i.test(n))d.mf.push(f)});\nvar gh=[],idl=[],sf=[],mt=[],tE=0,tI=0,tD=0;\ndevs.forEach(function(d){var s=dm[d.id];tI+=s.ih;tD+=s.dh;\nif(s.ft){var age=Math.floor((now-s.ft)/864e5)||1,ut=(Object.keys(s.ad).length/age)*100;\nif(ut<40){var an=s.ek*(365/span),cp=an>0?(12000/an):0;gh.push({nm:s.nm,val:ut.toFixed(0)+'%',w:800,dist:s.ek,cp:cp})}}\nif(s.ih>0)idl.push({nm:s.nm,hrs:s.ih,val:s.ih.toFixed(1)+' hrs',w:s.ih*4.3});tE+=s.ec});\nvar aE=devs.length>0?tE/devs.length:0;\ndevs.forEach(function(d){var s=dm[d.id],tA=aE>0?(s.ec/aE):0;\nif(tA>=2){var ct={},mx=0,tp=\"None\";s.ex.forEach(function(e){var r=rm[e.rule.id]||\"Event\";ct[r]=(ct[r]||0)+1;if(ct[r]>mx){mx=ct[r];tp=r}});\nsf.push({nm:s.nm,val:s.ec,avg:tA.toFixed(1),ta:tA,w:200,dt:tp,tc:ct})}\nif(s.mf.length>=3)mt.push({nm:s.nm,val:s.mf.length,w:800})});\nvar gC=gh.length*800,tpI=idl.sort(function(a,b){return b.hrs-a.hrs}).slice(0,10);\nvar tpH=tpI.reduce(function(a,b){return a+b.hrs},0),iC=tpI.reduce(function(a,b){return a+b.w},0);\nvar rC=sf.length*200,mC=mt.length*800,tW=gC+iC+rC+mC;\nvar tO=tI+tD,iR=tO>0?((tI/tO)*100):0;\nvar mc=0,dc=0;sf.forEach(function(h){var d=(h.dt||'').toLowerCase(),dev=dm[ni[h.nm]];\nvar isDevNoise=false;\ntry{if(dev&&dev.mf.length===0&&dev.af&&dev.af.length>0){var realF=dev.af.filter(function(f){var n=String(f&&f.diagnostic&&f.diagnostic.id||'').toLowerCase();return !isN(n)});isDevNoise=realF.length===0}}catch(e){console.warn('DevNoise check err:',e)}\nif(d.indexOf('engine')>-1||d.indexOf('fault')>-1||d.indexOf('light')>-1){if(isDevNoise){dc++;h._devNoise=true}else{mc++}}});\nvar dnX=[];devs.forEach(function(d){var s=dm[d.id];if(!s.af||s.af.length<5)return;var inSf=false;sf.forEach(function(h){if(h.nm===s.nm)inSf=true});if(inSf)return;var nF=s.af.filter(function(f){var n=String(f&&f.diagnostic&&f.diagnostic.id||'').toLowerCase();return isN(n)});if(nF.length>0&&nF.length===s.af.length){dc++;dnX.push({nm:s.nm,val:nF.length+' noise records',avg:'n/a',ta:0,w:0,dt:'Device Noise',tc:{},_devNoise:true,_extraDN:true})}});\nvar co2=tI*3.5*2.68;\nvar mk=Object.keys(ms).sort(),mCt=mk.length;\n/* Debug */\nvar ti={h:[],n:[],l:[],v:[]};devs.forEach(function(d){var s=dm[d.id];if(s.dkm>=4)ti.h.push(s);else if(s.dkm>=2)ti.n.push(s);else if(s.dkm>=1)ti.l.push(s);else ti.v.push(s)});\nvar mIdle={},mTr={};mk.forEach(function(k){mIdle[k]=ms[k].idle;mTr[k]=ms[k].trips});\n_dd={dv:devs.length,tr:trips.length,ex:exs.length,fl:faults.length,sp:span,mo:mCt,ih:tI,dh:tD,ir:iR,gh:gh.length,ic:tpI.length,hr:sf.length,mt:mt.length,tw:Math.round(tW),mk:mk,mi:mIdle};\n/* Render */\ndocument.getElementById('total-waste-text').textContent='$'+fC(tW);\nvar annLabel=span>=180?'Annual Projection':'Annual Estimate ('+span+'d sample \u2014 run quarterly for higher confidence)';\ndocument.getElementById('annual-text').textContent=annLabel+': $'+fC(tW*12)+' | '+span+' days across '+mCt+' month'+(mCt>1?'s':'');\nvar fst=document.getElementById('fleet-size-text');if(fst)fst.textContent=devs.length;\nvar dst=document.getElementById('data-span-text');if(dst)dst.textContent=span;\ndocument.getElementById('exec-summary-anchor').innerHTML=genES(gh,tpI,tpH,sf,mt,devs,span,tW,iC,iR,mc,dc,co2,mCt);\ndocument.getElementById('sustainability-anchor').innerHTML=genSust(tI,co2,span,iC);\ndocument.getElementById('monthly-trend-anchor').innerHTML=genTrend(mk,ms,devs.length,span);\nvar grid=document.getElementById('findings-grid');grid.innerHTML='';\ngrid.appendChild(mkGhost(gh,devs.length));\nvar idDesc=tpI.length>0?tpI[0].nm+' leads at '+tpI[0].val+'. Peak patterns show '+(tpI[0].pk>=21||tpI[0].pk<=5?'overnight warm-ups \u2014 block heaters recommended.':'midday dwell \u2014 engine-off policy needed.'):'';grid.appendChild(mkCard('\ud83d\udd25 Idle Time Burn','#dd6b20','$'+fC(iC),idDesc,'Hrs','val',tpI.slice(0,5)));\nvar hrDesc=sf.length>0?sf.length+' vehicles exceed 2\u00d7 fleet safety avg. Each costs ~$200/mo in wear and insurance risk.'+(dc>0?' <b>'+dc+' device noise issue'+(dc>1?'s':'')+' found</b> across fleet.':''):'';\ngrid.appendChild(mkCard('\u26a1 High-Risk Driving','#d69e2e','$'+fC(rC),hrDesc,'\u00d7Avg','avg',sf.slice(0,5)));\nvar brDesc=mt.length>0?mt.length+' vehicle'+(mt.length>1?'s have':' has')+' recurring fault codes. $400 inspection avoids $1,200-$3,500 breakdown.':'No recurring faults \u2014 fleet mechanical health is good.';\ngrid.appendChild(mkCard('\ud83d\udd27 Breakdown Risk','#3182ce','$'+fC(mC),brDesc,'Faults','val',mt.slice(0,5)));\ndocument.getElementById('action-plan-anchor').innerHTML=genAP(gh,tpI,sf,mt,dm,devs,span,ni,tW,iC,mC,tpH,rC,co2,rm,dnX);\ngenEv(dm,gh,tpI,sf,mt,rm,ni,devs,span,isE,trips.length);\nconsole.log(\"[v2.0] W:\"+tW+\" mo:\"+mCt+\" sp:\"+span+\"d\")}\n/* == EXEC SUMMARY == */\nfunction genES(gh,idl,tpH,hr,mt,dv,sp,tW,iC,iR,mc,dc,co2,mCt){\nvar aW=tW*12,conf=sp>=180?'':'<br><span style=\"font-size:11px;color:#a0aec0\">\u26a0\ufe0f Tool requested 365 days of history \u2014 database contains '+sp+' days. Projections based on available data. Run quarterly to build trend history.</span>';\nvar p='Your fleet of <b>'+dv.length+'</b> vehicles analyzed over <b>'+sp+' days</b>'+(mCt>1?' ('+mCt+' months)':'')+'. ';\nif(tW===0)p+='No significant recoverable costs found \u2014 fleet operating efficiently.';\nelse{p+='Identified <b style=\"color:#fc8181\">$'+fC(tW)+' in monthly recoverable costs</b> ($'+fC(aW)+' annual). ';\np+=aW>50000?'Requires immediate attention.':aW>20000?'Addressable through targeted changes.':'Moderate but prevents escalation.'}\nvar mo=new Date().getMonth(),s='';\nif(mo>=11||mo<=2){s='<b>\ud83c\udf41 Canadian Winter:</b> Some idle expected \u2014 NRCan recommends max 3-5 min warm-up for modern diesels. ';\nif(idl.length>0&&idl[0].hrs>5)s+='Your top idler at <b>'+idl[0].hrs.toFixed(1)+' hrs</b> far exceeds cold-weather needs \u2014 this is recoverable operational cost. ';\nif(mCt>=6)s+='Monthly trend below shows seasonal patterns across your data.';else s+='Re-run quarterly to build seasonal comparison \u2014 6+ months needed for reliable winter vs. spring baseline.'}\nelse if(mo>=3&&mo<=5)s='<b>\ud83c\udf41 Spring:</b> Fleets ramping up. Ghost vehicles now are chronic. Ideal baseline before peak.';\nelse if(mo>=6&&mo<=8){s='<b>\ud83c\udf41 Summer:</b> Peak season. Underperformers = strong removal candidates.';if(idl.length>0)s+=' Every idle hour is directly recoverable.'}\nelse s='<b>\ud83c\udf41 Fall:</b> Pre-winter maintenance window. Fix breakdowns before cold stress.';\nvar b='<b>\ud83d\udccf Benchmarks:</b> Fleet idle rate <b>'+iR.toFixed(0)+'%</b> '+(iR>30?'\u2014 <span style=\"color:#fc8181\">well above</span> NRCan &lt;15% target.':iR>15?'\u2014 <span style=\"color:#fbd38d\">above</span> NRCan &lt;15%.':'\u2014 <span style=\"color:#68d391\">within</span> NRCan &lt;15% target.');\nvar f='<b>Key Findings:</b> ',fs=[];\nif(gh.length>0)fs.push(gh.length+' vehicle'+(gh.length>1?'s':'')+' below 40% utilization (~$'+fC(gh.length*800)+'/mo)');\nif(idl.length>0)fs.push('Top '+idl.length+' idlers: '+tpH.toFixed(0)+' hrs ($'+fC(iC)+'/mo)');\nif(hr.length>0){if(mc>0)fs.push(hr.length+' exceed 2\u00d7 safety avg \u2014 <b>'+mc+' mechanical</b> (need mechanic, not coaching)');else fs.push(hr.length+' exceed 2\u00d7 safety avg')}\nif(dc>0)fs.push('<b>'+dc+' device issue'+(dc>1?'s':'')+'</b> detected \u2014 Geotab device reinstall, not engine problem')\nif(mt.length>0)fs.push(mt.length+' with recurring faults (inspect $400 vs $1,200+ breakdown)');\nf+=fs.length>0?fs.join('. ')+'.':'No significant issues.';\nvar bl='';if(tW>0){bl='<b style=\"color:#68d391\">\ud83d\udca1 Bottom Line:</b> ';var bg={a:'',c:0};\nif(gh.length*800>bg.c)bg={a:'ghost reduction',c:gh.length*800};if(iC>bg.c)bg={a:'idle reduction',c:iC};\nif(hr.length*200>bg.c)bg={a:'safety & mechanical',c:hr.length*200};if(mt.length*800>bg.c)bg={a:'proactive maintenance',c:mt.length*800};\nbl+='Largest: <b>'+bg.a+'</b> ($'+fC(bg.c)+'/mo). See 90-Day Roadmap below.'}\nreturn '<div style=\"background:linear-gradient(135deg,#1a365d,#2d3748);color:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 4px 15px rgba(0,0,0,.15)\"><h4 style=\"margin:0 0 4px 0\">\ud83d\udcca Executive Summary</h4><p style=\"margin:0 0 16px 0;font-size:11px;color:#a0aec0\">v2.0 | '+new Date().toLocaleDateString()+' | '+sp+'-day analysis</p><div style=\"font-size:13px;line-height:1.7;color:#e2e8f0\"><p style=\"margin:0 0 12px 0\">'+p+'</p><p style=\"margin:0 0 12px 0\">'+s+'</p><p style=\"margin:0 0 12px 0\">'+b+'</p><p style=\"margin:0 0 12px 0\">'+f+'</p>'+(bl?'<p style=\"margin:0\">'+bl+'</p>':'')+conf+'</div></div>'}\n/* == SUSTAINABILITY == */\nfunction genSust(tI,co2,sp,iC){\nif(tI<1)return '';\nvar aI=tI*(365/sp),aF=aI*3.5,aC=aF*2.68/1000,s65=aC*.65,trees=Math.round(s65/.022),cars=(aC/4.6).toFixed(1);\nvar h='<div style=\"background:linear-gradient(135deg,#22543d,#276749);color:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 4px 15px rgba(0,0,0,.15)\">';\nh+='<h4 style=\"margin:0 0 4px 0\">\ud83c\udf31 Fleet Sustainability &amp; Carbon Impact</h4>';\nh+='<p style=\"margin:0 0 12px 0;font-size:11px;color:#9ae6b4\">For ESG reporting, government contract bids &amp; ISSB S2 climate disclosure</p>';\nh+='<div style=\"font-size:12px;line-height:1.7;color:#c6f6d5\">';\nh+='<p style=\"margin:0 0 10px 0\"><b>\ud83c\udde8\ud83c\udde6 Why This Matters (2025-26):</b> Canada removed its consumer carbon tax on fuel in April 2025. However, fleet operators still face material sustainability obligations:</p>';\nh+='<div style=\"display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px\">';\nh+='<div class=\"gp\"><b>Clean Fuel Regs</b><br>Still in effect (SOR/2022-140). Suppliers pass costs through at $0.04-0.06/L. Less fuel = direct savings.</div>';\nh+='<div class=\"gp\"><b>Provincial Pricing</b><br>BC carbon tax + Quebec cap-and-trade active. Ontario fleets bidding on BC/QC contracts face compliance.</div>';\nh+='<div class=\"gp\"><b>Gov Contracts</b><br>Federal &amp; municipal RFPs increasingly require ESG metrics. Fleet emissions data = procurement advantage.</div>';\nh+='<div class=\"gp\"><b>ISSB S2 Disclosure</b><br>CSA adopting mandatory climate reporting. Public companies need Scope 1 fleet emissions data.</div></div>';\nh+='<b>Your Fleet Idle Carbon Footprint:</b>';\nh+='<table style=\"width:100%;font-size:12px;border-collapse:collapse;margin:8px 0 14px\"><thead><tr style=\"border-bottom:1px solid rgba(255,255,255,.3)\"><th style=\"padding:5px;text-align:left\">Metric</th><th class=\"tc\" style=\"padding:5px\">Monthly</th><th class=\"tc\" style=\"padding:5px\">Annual</th><th class=\"ty\" style=\"padding:5px\">-30%</th><th class=\"tg\" style=\"padding:5px\">-65% (90d target)</th></tr></thead><tbody>';\nh+='<tr><td style=\"padding:4px\">Fuel burned (idle)</td><td class=\"tc\">'+(tI*3.5).toFixed(0)+' L</td><td class=\"tc\">'+aF.toFixed(0)+' L</td><td class=\"ty\">'+(aF*.7).toFixed(0)+' L</td><td class=\"tg\">'+(aF*.35).toFixed(0)+' L</td></tr>';\nh+='<tr><td style=\"padding:4px\">CO\u2082 emissions</td><td class=\"tc\">'+(co2/1000).toFixed(1)+' t</td><td class=\"tc\">'+aC.toFixed(1)+' t</td><td class=\"ty\">'+(aC*.7).toFixed(1)+' t</td><td class=\"tg\">'+(aC*.35).toFixed(1)+' t</td></tr>';\nh+='<tr><td style=\"padding:4px\">Fuel cost</td><td class=\"tc\">$'+fC(tI*4.3)+'</td><td class=\"tc\">$'+fC(aI*4.3)+'</td><td class=\"ty\">$'+fC(aI*4.3*.7)+'</td><td class=\"tg\">$'+fC(aI*4.3*.35)+'</td></tr></tbody></table>';\nif(sp<180)h+='<div style=\"margin-bottom:10px;padding:6px 10px;background:rgba(255,255,255,0.08);border-radius:4px;font-size:10px;color:#9ae6b4\">\ud83d\udcca Annual projections estimated from '+sp+' days of data. Run quarterly to improve accuracy \u2014 seasonal variation may shift these numbers \u00b120%.</div>';\nh+='<div style=\"display:flex;gap:10px\">';\nh+='<div style=\"flex:1;text-align:center\" class=\"gp\">\ud83c\udf33 65% reduction = <b>'+s65.toFixed(1)+'t CO\u2082/yr</b> saved \u2248 <b>'+trees+' trees</b></div>';\nh+='<div style=\"flex:1;text-align:center\" class=\"gp\">\ud83d\ude97 Current idle = <b>'+cars+' passenger cars</b> driven for a year</div>';\nh+='<div style=\"flex:1;text-align:center\" class=\"gp\">\ud83d\udcca Report-ready for ESG filings &amp; gov contract bids</div></div>';\nh+='</div></div>';return h}\n/* == MONTHLY TREND == */\nfunction genTrend(mk,ms,fs,sp){\nif(mk.length<1)return '';\nvar mI=0;mk.forEach(function(k){if(ms[k].idle>mI)mI=ms[k].idle});if(mI<1)return '';\nvar cH=120,h='<div style=\"background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:24px;margin-bottom:24px\">';\nh+='<h5 style=\"margin:0 0 4px 0;color:#1a365d\">\ud83d\udcc8 Monthly Fleet Idle Trend</h5>';\nh+='<p style=\"margin:0 0 14px 0;font-size:11px;color:#718096\">'+mk.length+' month'+(mk.length>1?'s':'')+' | Bars=idle hrs | Color=season</p>';\nh+='<div style=\"display:flex;align-items:flex-end;height:'+cH+'px;gap:3px;padding:0 4px;border-bottom:2px solid #e2e8f0;margin-bottom:8px\">';\nmk.forEach(function(k){var m=ms[k],p=mI>0?(m.idle/mI*100):0,mn=parseInt(k.split('-')[1])-1,bH=Math.max(p*cH/100,4);\nh+='<div style=\"flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%\"><div style=\"font-size:9px;color:#4a5568;margin-bottom:2px\">'+m.idle.toFixed(0)+'h</div><div style=\"width:100%;max-width:40px;height:'+bH+'px;background:'+sC(sOf(mn))+';border-radius:3px 3px 0 0\" title=\"'+mL(k)+'\"></div></div>'});\nh+='</div><div style=\"display:flex;gap:3px;padding:0 4px\">';\nmk.forEach(function(k){h+='<div style=\"flex:1;text-align:center;font-size:9px;color:#718096\">'+mL(k)+'</div>'});\nh+='</div><div style=\"display:flex;gap:10px;margin-top:10px;font-size:10px;color:#718096\">';\nh+='<span>\u2744\ufe0f Winter</span><span>\ud83c\udf31 Spring</span><span>\u2600\ufe0f Summer</span><span>\ud83c\udf42 Fall</span></div>';\nh+='<details style=\"margin-top:10px\"><summary style=\"font-size:11px;color:#3182ce;cursor:pointer\">Monthly breakdown</summary>';\nh+='<table class=\"table table-sm\" style=\"font-size:10px;margin-top:8px\"><thead><tr><th>Month</th><th>Season</th><th>Trips</th><th>Idle Hrs</th><th>CO\u2082 (t)</th><th>Recoverable</th></tr></thead><tbody>';\nmk.forEach(function(k){var m=ms[k],mn=parseInt(k.split('-')[1])-1,sn=sOf(mn);\nh+='<tr><td>'+mL(k)+'</td><td>'+sI(sn)+'</td><td>'+m.trips+'</td><td>'+m.idle.toFixed(1)+'</td><td>'+(m.co2/1000).toFixed(2)+'</td><td>$'+fC(m.idle*4.3)+'</td></tr>'});\nh+='</tbody></table></details>';\nif(sp<90)h+='<div style=\"margin-top:10px;padding:10px;background:#fff5f5;border-left:4px solid #fc8181;border-radius:0 6px 6px 0;font-size:12px\"><b>\ud83d\udcca Data Maturity:</b> This analysis covers <b>'+sp+' days</b>. Seasonal comparison requires 6+ months of data. Run this tool quarterly \u2014 each run strengthens the trend line and improves projection confidence. Schedule next audit for <b>'+new Date(Date.now()+90*864e5).toLocaleDateString()+'</b>.</div>';\nif(mk.length>=6){var wI=0,wM=0,nI=0,nM=0;mk.forEach(function(k){var mn=parseInt(k.split('-')[1])-1,m=ms[k];\nif(mn>=11||mn<=2){wI+=m.idle;wM++}else{nI+=m.idle;nM++}});\nif(wM>0&&nM>0){var wA=wI/wM,nA=nI/nM,df=nA>0?((wA-nA)/nA*100):0;\nh+='<div style=\"margin-top:10px;padding:10px;background:#ebf8ff;border-left:4px solid #3182ce;border-radius:0 6px 6px 0;font-size:12px\"><b>Seasonality:</b> ';\nif(df>20)h+='Winter avg <b>'+wA.toFixed(0)+'h</b> vs non-winter <b>'+nA.toFixed(0)+'h</b> \u2014 <b>'+Math.round(df)+'% winter premium</b>. Target non-winter idle first, then set separate winter targets.';\nelse if(df>0)h+='Minimal seasonal variation \u2014 idle is habitual, not weather-driven. Anti-idle policy effective year-round.';\nelse h+='Non-winter months show higher idle \u2014 focus reduction on peak operating months.';\nh+='</div>'}}h+='</div>';return h}\n/* == ACTION PLAN == */\nfunction genAP(gh,idl,hr,mt,dm,dv,sp,ni,tW,iC,mC,iH,rC,co2,rm,dnX){\nvar mV=[],dV=[],bV=[];hr.forEach(function(h){var d=(h.dt||'').toLowerCase();\nif(d.indexOf('engine')>-1||d.indexOf('fault')>-1||d.indexOf('light')>-1){if(h._devNoise)dV.push(h);else mV.push(h)}else bV.push(h)});\nif(dnX)dnX.forEach(function(x){dV.push(x)});\nvar t30=Math.max(0,tW-(iC*.3)-mC),t60=tW*.5,t90=tW*.35,ct=co2/1000;\nvar o='<div style=\"background:#fff;border:2px solid #1a365d;border-radius:12px;padding:24px;margin-bottom:24px\"><div style=\"display:flex;justify-content:space-between;align-items:center\"><h4 style=\"margin:0;color:#1a365d\">\ud83d\uddd3\ufe0f Fleet Optimization Roadmap</h4><span style=\"font-size:11px;color:#718096;cursor:pointer\" onclick=\"window.print()\">\ud83d\udda8\ufe0f Print</span></div><p class=\"si\" style=\"margin:8px 0 16px;border:none;background:#edf2f7\">Your 90-day plan. Each card names who, what, which vehicles, and how to measure. Start at the top. Print and hand to your team.</p>';\n/* URGENT with fault codes */\nif(mV.length>0||dV.length>0||mt.length>0){o+='<div style=\"background:#fff5f5;border:2px solid #fc8181;border-radius:8px;padding:16px;margin-bottom:20px\"><h5 style=\"margin:0 0 4px 0;color:#c53030;font-size:15px\">\u26a0\ufe0f URGENT: Safety &amp; Mechanical (This Week)</h5><p style=\"margin:0 0 12px 0;font-size:13px;color:#742a2a\">$400 proactive inspection now avoids $1,200-$3,500 roadside breakdown. <b>Assign today.</b></p>';\nvar seen={};\nmV.forEach(function(v){if(seen[v.nm])return;seen[v.nm]=true;\nvar dev=dm[ni[v.nm]],fi='',ei='',mechNote='';\n/* Try mechanical faults first, then filtered all-faults (excluding device noise) */\nvar faultSrc=[];\nif(dev&&dev.mf.length>0)faultSrc=dev.mf;\nelse if(dev&&dev.af.length>0)faultSrc=dev.af.filter(function(f){var n=(f.diagnostic.id||'').toLowerCase();return !isN(n)});\nif(faultSrc.length>0){var fc={};faultSrc.forEach(function(f){var n=cD(f.diagnostic.id);fc[n]=(fc[n]||0)+1});\nvar fl=[];Object.keys(fc).sort(function(a,b){return fc[b]-fc[a]}).forEach(function(k){fl.push('<li>'+k+' <b>(\u00d7'+fc[k]+')</b></li>')});\nfi='<b>\ud83d\udd0d Diagnostic Codes ('+faultSrc.length+'):</b><ul class=\"fault-list\">'+fl.join('')+'</ul>';\nvar uc=Object.keys(fc).length;\nmechNote=uc===1?'Single recurring code \u2014 mechanic should focus on this system.':uc<=3?'Related codes \u2014 likely system-level failure.':'Multiple systems \u2014 full diagnostic required.'}\nelse{/* No FaultData at all \u2014 use exception events as evidence */\nfi='<b>\ud83d\udd0d No DTCs in Geotab</b> \u2014 '+v.val+' exception events indicate intermittent faults not captured as diagnostic codes.';\nmechNote='Pull DTCs via OBD-II/J1939 scanner during inspection.';\n/* Show top 5 exception events with timestamps */\nif(dev&&dev.ex.length>0){var topEv=dev.ex.filter(function(e){var rn=rm[e.rule.id]||'';return rn.toLowerCase().indexOf('engine')>-1||rn.toLowerCase().indexOf('fault')>-1}).sort(function(a,b){return new Date(b.activeFrom)-new Date(a.activeFrom)}).slice(0,5);\nif(topEv.length>0){fi+='<br><b>Recent fault events:</b><ul class=\"fault-list\">';\ntopEv.forEach(function(e){fi+='<li>'+e.activeFrom.substring(0,16).replace('T',' ')+' \u2014 '+(rm[e.rule.id]||'Event')+(e.duration?' ('+fD(e.duration)+')':'')+'</li>'});\nfi+='</ul>'}}}\nif(v.tc){var tc=[];Object.keys(v.tc).sort(function(a,b){return v.tc[b]-v.tc[a]}).forEach(function(k){tc.push(k+':'+v.tc[k])});ei='<br><b>Event breakdown:</b> '+tc.join(' | ')}\no+=bA('#e53e3e','\ud83d\udd27 <b>'+v.nm+'</b> \u2014 '+v.val+' events ('+v.avg+'\u00d7 avg)','Maintenance Coordinator','Pull from service. Book diagnostic. <b>Mechanical, NOT driver behavior.</b>'+(fi?'<div style=\"background:#f7fafc;border-radius:4px;padding:8px;margin:6px 0\">'+fi+'</div>':'')+(mechNote?'<div style=\"background:#f0fff4;border-radius:4px;padding:6px 8px;margin:4px 0;font-size:11px\"><b>\u2699\ufe0f</b> '+mechNote+'</div>':'')+(ei?'<div style=\"font-size:10px;color:#718096;margin-top:4px\">'+ei.replace('<br>','')+'</div>':'')+'<div style=\"font-size:10px;color:#718096;margin-top:4px\"><b>\ud83d\udccd</b> MyGeotab \u2192 Faults \u2192 '+v.nm+'</div>',v.nm,'Diagnostic within 5 business days.','~$400','Avoids $1,200-$3,500 breakdown')});\n/* DEVICE ISSUES \u2014 Geotab device noise, NOT engine faults */\ndV.forEach(function(v){if(seen[v.nm])return;seen[v.nm]=true;\nvar dev=dm[ni[v.nm]],noiseCount=0;if(dev&&dev.af){dev.af.forEach(function(f){var n=String(f&&f.diagnostic&&f.diagnostic.id||'').toLowerCase();if(n.indexOf('accelerometer')>-1)noiseCount++})}\nvar cardTitle=v._extraDN?'\ud83d\udcf1 <b>'+v.nm+'</b> \u2014 '+noiseCount+' accelerometer noise records \u2014 <span style=\"color:#805ad5;font-weight:bold\">DEVICE ISSUE</span>':'\ud83d\udcf1 <b>'+v.nm+'</b> \u2014 '+v.val+' events ('+v.avg+'\u00d7 avg) \u2014 <span style=\"color:#805ad5;font-weight:bold\">DEVICE ISSUE</span>';\nvar ei='';if(v.tc){var tc=[];Object.keys(v.tc).sort(function(a,b){return v.tc[b]-v.tc[a]}).forEach(function(k){tc.push(k+':'+v.tc[k])});ei='<br><b>Event breakdown:</b> '+tc.join(' | ')}\no+=bA('#805ad5',cardTitle,'IT / Geotab Support','<div style=\"background:#faf5ff;border-radius:4px;padding:8px;margin:4px 0\"><b>\u26a0\ufe0f NOT an engine fault.</b> Geotab GO device: '+noiseCount+' accelerometer noise records triggering \"Engine Fault Exception\" rule. Root cause is <b>device installation</b>, not engine.</div><div style=\"background:#f0fff4;border-radius:4px;padding:6px 8px;margin:4px 0;font-size:11px\"><b>\ud83d\udcf1</b> Check device mounting, wiring, firmware. Contact Geotab support if persistent. <b>Do NOT send to mechanic.</b></div>'+(ei?'<div style=\"font-size:10px;color:#718096;margin-top:4px\">'+ei.replace('<br>','')+'</div>':'')+'<div style=\"font-size:10px;color:#718096;margin-top:4px\"><b>\ud83d\udccd</b> MyGeotab \u2192 Admin \u2192 Devices \u2192 '+v.nm+'</div>',v.nm,'Device checked within 10 business days.','$0 (warranty) or ~$150','Eliminates false alerts + restores safety data')});\nmt.forEach(function(v){if(seen[v.nm])return;seen[v.nm]=true;\nvar dev=dm[ni[v.nm]],fi='';\nvar faultSrc=[];\nif(dev&&dev.mf.length>0)faultSrc=dev.mf;\nelse if(dev&&dev.af.length>0)faultSrc=dev.af.filter(function(f){var n=(f.diagnostic.id||'').toLowerCase();return !isN(n)});\nif(faultSrc.length>0){var fc={};faultSrc.forEach(function(f){var n=cD(f.diagnostic.id);fc[n]=(fc[n]||0)+1});\nvar fl=[];Object.keys(fc).sort(function(a,b){return fc[b]-fc[a]}).forEach(function(k){fl.push('<li>'+k+' <b>(\u00d7'+fc[k]+')</b></li>')});\nfi='<div style=\"background:#f7fafc;border-radius:4px;padding:8px;margin:6px 0\"><b>\ud83d\udd0d Codes ('+faultSrc.length+'):</b><ul class=\"fault-list\">'+fl.join('')+'</ul></div>';\nvar uc=Object.keys(fc).length;\nfi+='<div style=\"background:#f0fff4;border-radius:4px;padding:6px 8px;margin:4px 0;font-size:11px\"><b>\u2699\ufe0f</b> '+(uc===1?'Single recurring code \u2014 focus on this system.':uc<=3?'Related codes \u2014 system-level diagnosis needed.':'Diverse codes \u2014 full inspection required.')+'</div>'}\no+=bA('#e53e3e','\ud83d\udd27 <b>'+v.nm+'</b> \u2014 '+v.val+' recurring faults','Maintenance Coordinator','Proactive inspection needed. Repeated codes signal component failure.'+fi+'<div style=\"font-size:10px;color:#718096;margin-top:4px\"><b>\ud83d\udccd</b> MyGeotab \u2192 Faults \u2192 '+v.nm+'</div>',v.nm,'Inspection within 10 business days.','~$400','Prevents $1,200+ breakdown')});\no+='</div>'}\n/* 30 DAY */\no+='<div style=\"border-left:4px solid #38a169;padding:16px;margin-bottom:20px;background:#f0fff4;border-radius:0 8px 8px 0\"><h5 style=\"margin:0 0 4px 0;color:#276749;font-size:15px\">\ud83d\udcc5 30-Day Plan: Quick Wins</h5><p style=\"margin:0 0 4px 0;font-size:13px;color:#276749;font-weight:bold\">\ud83c\udfaf $'+fC(tW)+' \u2192 $'+fC(t30)+'</p><p style=\"margin:0 0 14px 0;font-size:12px;color:#2f855a\">Low-cost, high-impact actions. Most cost $0. Establish baseline monitoring and stop the bleed.</p>';\nif(idl.length>0){o+=bA('#38a169','\ud83d\udccb Anti-Idle Policy (Week 1)','Fleet Manager \u2192 All Drivers','Engines OFF after 3 min. Exception: below -15\u00b0C diesel (NRCan: 3-5 min max). Post in break rooms.','All \u2014 monitor: '+idl.slice(0,3).map(function(i){return i.nm}).join(', '),'Productivity weekly. Baseline: '+iH.toFixed(0)+' hrs. Day 30 target: '+(iH*.7).toFixed(0)+' hrs (-30%).','$0','~$'+fC(iC*.3)+'/mo + '+(ct*.3).toFixed(1)+'t CO\u2082');\no+=bA('#38a169','\ud83d\udd0c Block Heaters (Week 1-2)','Maintenance','Top 3 idlers. $200-400 installed. Eliminates 10-20 min warm-up.',idl.slice(0,3).map(function(i){return i.nm}).join(', '),'Quotes by Day 14.','$200-400/v','~$3.50/day (60-90d payback)')}\nif(mV.length>0)o+=bA('#38a169','\ud83d\udd27 Verify Inspections (Week 2)','Fleet Manager','Confirm Urgent vehicles inspected: booked \u2192 diagnosed \u2192 repaired.',mV.map(function(v){return v.nm}).join(', '),'All '+mV.length+' by Day 14.','~$400/v','Avoids $1,200-$3,500');\nif(dV.length>0)o+=bA('#38a169','\ud83d\udcf1 Device Check (Week 2)','IT / Fleet Admin','Verify Geotab GO device mounting and firmware on flagged vehicles.',dV.map(function(v){return v.nm}).join(', '),'All '+dV.length+' checked by Day 14.','$0','Eliminates false alerts');\nif(bV.length>0)o+=bA('#38a169','\ud83d\udc64 Driver Coaching (Week 2-3)','Safety Lead','One-on-one. Share data. Target: -50% events in 30d.',bV.map(function(v){return v.nm}).join(', '),'Done by Day 21.','$0','Reduces insurance risk');\no+=bA('#38a169','\ud83d\udcca MyGeotab Monitoring (Week 2)','Fleet Admin','Weekly auto-reports: idle, exceptions, faults.','Fleet-wide','Running by Day 14.','$0','Ongoing detection');\no+='</div>';\n/* 60 DAY */\no+='<div style=\"border-left:4px solid #3182ce;padding:16px;margin-bottom:20px;background:#ebf8ff;border-radius:0 8px 8px 0\"><h5 style=\"margin:0 0 4px 0;color:#2b6cb0;font-size:15px\">\ud83d\udcc5 60-Day Plan: Measure &amp; Adjust</h5><p style=\"margin:0 0 4px 0;font-size:13px;color:#2b6cb0;font-weight:bold\">\ud83c\udfaf $'+fC(t60)+' (50% reduction)</p><p style=\"margin:0 0 14px 0;font-size:12px;color:#2a69ac\">Compare before and after. What worked? Adjust course. Data-driven decisions replace guesswork.</p>';\no+=bE('#3182ce','\ud83d\udd04 Re-Run Audit (Day 30)','Fleet Manager','Compare side-by-side. Idle down 30%? Faults resolved?','Fleet-wide','Both reports printed.','If idle NOT down 20%: escalate to GPS idle alerts.');\no+=bE('#3182ce','\ud83d\udcc8 Driver Scorecards (Day 35)','Manager + Safety','Compare before/after. Recognize improvements.','Flagged drivers','Each shows improvement OR documented plan.','No improvement after 30d \u2192 progressive discipline.');\nif(idl.length>0)o+=bE('#3182ce','\ud83d\udd0c Block Heaters (Day 35-45)','Maintenance','Install. Train: plug in overnight.','Equipped','10-15 min/day idle reduction.','Unchanged \u2192 driver habit.');\nif(gh.length>0)o+=bE('#3182ce','\ud83d\udcca Ghost Review (Day 35-50)','Manager + Depts','Assigned? Pool? Keep/Share/Remove.',gh.map(function(g){return g.nm}).join(', '),'Written recommendation per vehicle.','<40% unjustified \u2192 lease return.');\no+=bE('#3182ce','\ud83d\udcb0 Actual Savings (Day 55)','Fleet Manager','Fuel receipts + MyGeotab vs $'+fC(tW)+'/mo baseline. Include CO\u2082 for ESG.','Fleet-wide','Report with real $ + CO\u2082.','<30% target \u2192 idle shutoff timers.');\no+='</div>';\n/* 90 DAY */\no+='<div style=\"border-left:4px solid #805ad5;padding:16px;margin-bottom:20px;background:#faf5ff;border-radius:0 8px 8px 0\"><h5 style=\"margin:0 0 4px 0;color:#553c9a;font-size:15px\">\ud83d\udcc5 90-Day Plan: Systematize</h5><p style=\"margin:0 0 4px 0;font-size:13px;color:#553c9a;font-weight:bold\">\ud83c\udfaf $'+fC(t90)+' (65% reduction) + SOP</p><p style=\"margin:0 0 14px 0;font-size:12px;color:#6b46c1\">Lock in gains with SOPs. Without them, improvements regress within 6 months.</p>';\no+=bA('#805ad5','\ud83d\udd04 Third Audit','Fleet Manager','3 data points. Present trend to management.','Fleet-wide','Three reports showing trend.','$0','Validates ROI');\nvar mo=new Date().getMonth();\nif(mo>=11||mo<=2)o+=bA('#805ad5','\ud83c\udf31 Spring Baseline (Apr/May)','Fleet Manager','Schedule spring audit. Compare winter vs spring idle. With 2+ quarters, seasonal patterns become defensible. Ghost vehicles should show higher spring utilization \u2014 if not, confirms year-round underuse.','Flagged','Calendar: April 15.','$0','Builds data confidence');\nif(gh.length>0)o+=bA('#805ad5','\ud83d\udccb Fleet Right-Sizing','Manager + Finance','Finalize return/reassign. Lease terms.',gh.map(function(g){return g.nm}).join(', '),'Decision per vehicle.','Varies','$800/mo per vehicle');\no+=bA('#805ad5','\ud83d\udcca SOP','Fleet Manager','(1) Monthly audit 1st Monday (2) Weekly idle review (3) Faults within 48h (4) Quarterly fleet review (5) Annual ESG report.','Fleet-wide','Written SOP approved. Calendar set.','$0','Prevents regression');\no+='</div>';\n/* PROGRESS TRACKER */\no+='<div style=\"background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px\"><h5 style=\"margin:0 0 8px 0;color:#1a365d\">\ud83d\udcc8 Progress Tracker</h5><table style=\"width:100%;font-size:11px;border-collapse:collapse\"><thead><tr style=\"background:#edf2f7\"><th style=\"padding:6px;text-align:left\">Metric</th><th class=\"tc\" style=\"padding:6px\">Today</th><th class=\"tc\" style=\"padding:6px\">30d</th><th class=\"tc\" style=\"padding:6px\">60d</th><th class=\"tc\" style=\"padding:6px\">90d</th></tr></thead><tbody>';\no+='<tr><td style=\"padding:5px\">Recoverable/mo</td><td class=\"tr\" style=\"font-weight:bold\">$'+fC(tW)+'</td><td class=\"tc\">$'+fC(t30)+'</td><td class=\"tc\">$'+fC(t60)+'</td><td class=\"tg\" style=\"font-weight:bold\">$'+fC(t90)+'</td></tr>';\nif(iH>0)o+='<tr><td style=\"padding:5px\">Idle hrs/mo</td><td class=\"tr\">'+iH.toFixed(0)+'</td><td class=\"tc\">'+(iH*.7).toFixed(0)+'</td><td class=\"tc\">'+(iH*.5).toFixed(0)+'</td><td class=\"tg\">'+(iH*.4).toFixed(0)+'</td></tr>';\nif(hr.length>0)o+='<tr><td style=\"padding:5px\">Vehicles>2\u00d7 safety</td><td class=\"tr\">'+hr.length+'</td><td class=\"tc\">'+Math.ceil(hr.length*.6)+'</td><td class=\"tc\">1-2</td><td class=\"tg\">0</td></tr>';\nif(mt.length>0)o+='<tr><td style=\"padding:5px\">Breakdown risk</td><td class=\"tr\">'+mt.length+'</td><td class=\"tg\">0</td><td class=\"tg\">0</td><td class=\"tg\">0</td></tr>';\nif(ct>.05)o+='<tr><td style=\"padding:5px\">\ud83c\udf31 CO\u2082 idle (t/mo)</td><td class=\"tr\">'+ct.toFixed(1)+'</td><td class=\"tc\">'+(ct*.7).toFixed(1)+'</td><td class=\"tc\">'+(ct*.5).toFixed(1)+'</td><td class=\"tg\">'+(ct*.4).toFixed(1)+'</td></tr>';\no+='</tbody></table><p style=\"margin:10px 0 0;font-size:11px;color:#718096;text-align:center\">Annual savings at 90d: <b style=\"color:#38a169\">$'+fC((tW-t90)*12)+'</b> + <b style=\"color:#38a169\">'+(ct*.6*12).toFixed(1)+'t CO\u2082</b></p></div>';\n/* CHECKLIST */\no+='<div style=\"border:2px dashed #718096;border-radius:8px;padding:20px;background:#fff;font-size:12px;line-height:2.1\"><div style=\"display:flex;justify-content:space-between\"><h5 style=\"margin:0 0 10px 0\">\u2705 Checklist</h5><span style=\"font-size:11px;color:#718096\">\u2702\ufe0f Print</span></div>';\nif(mV.length>0||dV.length>0||mt.length>0){o+='<b style=\"color:#c53030\">URGENT:</b><br>';var sn={};mV.concat(mt).forEach(function(v){if(!sn[v.nm]){sn[v.nm]=true;o+='\u2610 Diagnostic (mechanic): '+v.nm+'<br>'}});dV.forEach(function(v){if(!sn[v.nm]){sn[v.nm]=true;o+='\u2610 Device check (IT/Geotab): '+v.nm+'<br>'}})}o+='<b style=\"color:#38a169\">MONTH 1:</b><br>';\nif(idl.length>0)o+='\u2610 Anti-idle policy distributed<br>\u2610 Signage posted<br>\u2610 Block heater quotes: '+idl.slice(0,3).map(function(i){return i.nm}).join(', ')+'<br>';\no+='\u2610 Weekly MyGeotab reports set up<br>';\nif(bV.length>0)o+='\u2610 Safety talks: '+bV.map(function(v){return v.nm}).join(', ')+'<br>';\no+='\u2610 <b>Day 30: Re-run audit</b><br>';\no+='<b style=\"color:#3182ce\">MONTH 2:</b><br>\u2610 Driver scorecards<br>';\nif(idl.length>0)o+='\u2610 Block heaters installed<br>';\nif(gh.length>0)o+='\u2610 Ghost review: '+gh.map(function(g){return g.nm}).join(', ')+'<br>';\no+='\u2610 Day 45: Actual $ saved + CO\u2082<br>\u2610 <b>Day 60: Re-run audit</b><br>';\no+='<b style=\"color:#805ad5\">MONTH 3:</b><br>';\nif(mo>=11||mo<=2)o+='\u2610 Spring audit (Apr 15)<br>';\nif(gh.length>0)o+='\u2610 Fleet right-sizing decisions<br>';\no+='\u2610 SOP in operations manual<br>\u2610 <b>Present 90-day results + CO\u2082 to management</b><br>';\no+='</div></div>';return o}\nfunction bA(c,t,w,a,v,m,co,s){return '<div class=\"ac\" style=\"border-left:4px solid '+c+';padding:14px 16px\"><div style=\"font-size:13px;font-weight:bold;margin-bottom:8px\">'+t+'</div><div style=\"display:grid;grid-template-columns:70px 1fr;gap:2px 10px;font-size:11px\"><span class=\"rw\">Assign to</span><span>'+w+'</span><span class=\"rw\">Action</span><div>'+a+'</div><span class=\"rw\">Vehicles</span><span>'+v+'</span><span class=\"rw\">Measure</span><span>'+m+'</span></div><div style=\"display:flex;gap:16px;margin-top:8px;padding-top:8px;border-top:1px solid #e2e8f0;font-size:11px\"><span>\ud83d\udcb0 Cost: <b>'+co+'</b></span><span style=\"color:#38a169\">\ud83d\udcc8 Savings: <b>'+s+'</b></span></div></div>'}\nfunction bE(c,t,w,a,v,m,e){return '<div class=\"ac\" style=\"border-left:4px solid '+c+';padding:14px 16px\"><div style=\"font-size:13px;font-weight:bold;margin-bottom:8px\">'+t+'</div><div style=\"display:grid;grid-template-columns:70px 1fr;gap:2px 10px;font-size:11px\"><span class=\"rw\">Assign to</span><span>'+w+'</span><span class=\"rw\">Action</span><div>'+a+'</div><span class=\"rw\">Vehicles</span><span>'+v+'</span><span class=\"rw\">Measure</span><span>'+m+'</span></div><div style=\"margin-top:8px;padding:6px 10px;background:#fff5f5;border-radius:4px;font-size:11px;color:#e53e3e\"><b>\u26a0\ufe0f If stuck:</b> '+e+'</div></div>'}\n/* == CARDS == */\nfunction mkGhost(l,fc){var ghDesc=l.length>0?l.length+' of '+fc+' vehicles below 40% utilization. At $800/mo each (lease+insurance), these represent $'+fC(l.length*800)+'/mo in underused assets.':'All vehicles above 40% utilization \u2014 no ghost vehicles.';var r=l.length>0?'':'<tr><td colspan=\"4\">\u2705 None</td></tr>';l.forEach(function(i){r+='<tr><td>'+i.nm+'</td><td>'+i.val+'</td><td>'+i.dist.toFixed(0)+'</td><td>$'+Math.round(i.cp)+'</td></tr>'});return cW('\ud83d\udeab Ghost Vehicles','#e53e3e',ghDesc,'Util','km','$/km',r)}\nfunction mkCard(t,c,a,desc,u,vK,l){var r=l.length>0?'':'<tr><td colspan=\"2\">None</td></tr>';l.forEach(function(i){r+='<tr><td>'+i.nm+'</td><td>'+i[vK]+'</td></tr>'});return cW(t,c,desc,u,'',null,r,a)}\nfunction cW(t,c,desc,u1,u2,u3,r,a){var d=document.createElement('div');d.className='col-md-6 mb-3';d.innerHTML='<div class=\"card h-100 shadow-sm\" style=\"border-left:5px solid '+c+'\"><div class=\"card-body\"><h6>'+t+'</h6>'+(a?'<h6 style=\"color:'+c+'\">'+a+'</h6>':'')+(desc?'<p style=\"font-size:11px;color:#4a5568;margin:4px 0 8px;line-height:1.5\">'+desc+'</p>':'')+'<table class=\"table table-sm mt-2\" style=\"font-size:10px\"><thead><tr><th>Vehicle</th><th>'+u1+'</th>'+(u2?'<th>'+u2+'</th>':'')+(u3?'<th>'+u3+'</th>':'')+'</tr></thead><tbody>'+r+'</tbody></table></div></div>';return d}\n/* == EVIDENCE == */\nfunction genEv(dm,gh,idl,hr,mt,rm,ni,dv,sp,isE,tT){\nvar c=document.getElementById('evidence-report');c.style.display='block';\nvar h='<hr><h4>\ud83d\udccb Evidence Report</h4><p class=\"si\">Data backing each finding above. Use to verify claims or brief your mechanic.</p><h5>\ud83d\udcca Fleet Overview</h5><p style=\"font-size:13px\">'+dv.length+' units | '+sp+' days | '+tT+' trips</p>';\nvar uB={a:0,b:0,c:0,d:0};\ndv.forEach(function(d){var s=dm[d.id],u=(Object.keys(s.ad).length/sp)*100;if(u<25)uB.a++;else if(u<50)uB.b++;else if(u<75)uB.c++;else uB.d++});\nh+='<div style=\"font-size:12px;font-family:monospace;background:#f7fafc;padding:8px;margin:8px 0 12px;border-radius:4px\"><span style=\"color:#e53e3e\">0-25%:   '+'\u2588'.repeat(uB.a)+' '+uB.a+'</span><br><span style=\"color:#dd6b20\">25-50%:  '+'\u2588'.repeat(uB.b)+' '+uB.b+'</span><br><span style=\"color:#d69e2e\">50-75%:  '+'\u2588'.repeat(uB.c)+' '+uB.c+'</span><br><span style=\"color:#38a169\">75-100%: '+'\u2588'.repeat(uB.d)+' '+uB.d+'</span></div>';\nfunction mT(rows,cols){var t='<table class=\"table table-sm\" style=\"font-size:10px\"><thead><tr>';cols.forEach(function(c){t+='<th>'+c+'</th>'});t+='</tr></thead><tbody>';rows.forEach(function(r){t+='<tr>';r.forEach(function(c){t+='<td>'+c+'</td>'});t+='</tr>'});return t+'</tbody></table>'}\nif(idl.length>0){h+='<hr><h5>\ud83d\udd25 Idle Details</h5>';\nidl.forEach(function(il){var d=dm[ni[il.nm]];if(!d)return;\nvar it=(d.tr||[]).filter(function(t){return pD(t.idlingDuration)>.001}).sort(function(a,b){return pD(b.idlingDuration)-pD(a.idlingDuration)}).slice(0,8);\nvar hb={};(d.tr||[]).forEach(function(t){var ih=pD(t.idlingDuration);if(ih>.001&&t.start){var hr=new Date(t.start).getHours();hb[hr]=(hb[hr]||0)+ih}});\nvar bS=0,bM=0;for(var x=0;x<24;x++){var w=(hb[x]||0)+(hb[(x+1)%24]||0)+(hb[(x+2)%24]||0);if(w>bM){bM=w;bS=x}}\nvar pE=(bS+3)%24,pT=(bS<10?'0':'')+bS+':00-'+(pE<10?'0':'')+pE+':00';\nvar tV=0;Object.keys(hb).forEach(function(k){tV+=hb[k]});var pP=tV>0?Math.round(bM/tV*100):0;\nvar rc=bS<7?'\ud83c\udf19 Warm-up.':bS<14?'\u2600\ufe0f Midday dwell.':'\ud83c\udf19 Evening.';\nh+='<div class=\"vc\"><b>'+il.nm+'</b> \u2014 '+il.hrs.toFixed(1)+' hrs (~$'+Math.round(il.w)+'/mo)<div class=\"ab\">Peak <b>'+pT+'</b> ('+pP+'%) | '+d.tr.length+' trips | '+rc+'</div>';\nvar rows=[];it.forEach(function(t){var ih=pD(t.idlingDuration),dh=pD(t.drivingDuration),tot=dh+ih;rows.push([(t.start?t.start.substring(0,10):'\u2014'),fD(t.idlingDuration),(tot>0?Math.round(ih/tot*100):0)+'%'])});\nh+=mT(rows,['Date','Idle','%Trip'])+'</div>'})}\nif(hr.length>0){h+='<hr><h5>\u26a1 High-Risk Details</h5>';\nhr.forEach(function(r){var d=dm[ni[r.nm]];if(!d)return;\nvar ct={},mx=0,tR=\"Event\";(d.ex||[]).forEach(function(e){var r2=rm[e.rule.id]||\"Event\";ct[r2]=(ct[r2]||0)+1;if(ct[r2]>mx){mx=ct[r2];tR=r2}});\nvar bd=[];Object.keys(ct).sort(function(a,b){return ct[b]-ct[a]}).forEach(function(k){bd.push(k+':'+ct[k])});\nvar dL=tR.toLowerCase(),rc;if(r._devNoise)rc='\ud83d\udcf1 Device noise.';else if(dL.indexOf('engine')>-1||dL.indexOf('fault')>-1)rc='\u2699\ufe0f Mechanical.';else if(dL.indexOf('speed')>-1)rc='\ud83c\udfce\ufe0f Speed.';else rc='\ud83d\udccb Mixed.';\nvar ev=(d.ex||[]).sort(function(a,b){return new Date(b.activeFrom)-new Date(a.activeFrom)}).slice(0,8);\nh+='<div class=\"vc\"><b>'+r.nm+'</b> \u2014 '+d.ec+' events ('+r.avg+'\u00d7)<div class=\"ay\">'+tR+' | '+bd.join(' | ')+'<br>'+rc+'</div>';\nvar rows=[];ev.forEach(function(e){rows.push([(e.activeFrom?e.activeFrom.substring(0,16).replace('T',' '):'\u2014'),(rm[e.rule.id]||'Event'),(e.duration?fD(e.duration):'\u2014')])});\nh+=mT(rows,['Time','Rule','Dur'])+'</div>'})}\nif(mt.length>0){h+='<hr><h5>\ud83d\udd27 Breakdown Risk</h5>';\nmt.forEach(function(m){var d=dm[ni[m.nm]];if(!d)return;\nvar fl=(d.mf||[]).sort(function(a,b){return new Date(b.dateTime||b.date||0)-new Date(a.dateTime||a.date||0)}).slice(0,8);\nvar dt={};fl.forEach(function(f){var dn=cD(f.diagnostic.id);dt[dn]=(dt[dn]||0)+1});\nvar ds=[];Object.keys(dt).forEach(function(k){ds.push(k+' (\u00d7'+dt[k]+')')});\nh+='<div class=\"vc\"><b>'+m.nm+'</b> \u2014 '+m.val+' faults<div class=\"az\">'+ds.join(', ')+'</div>';\nvar rows=[];fl.forEach(function(f){rows.push([(f.dateTime||f.date||'').substring(0,16).replace('T',' '),cD(f.diagnostic.id),(f.failureMode&&f.failureMode.name)||'\u2014'])});\nh+=mT(rows,['Time','Code','Mode'])+'</div>'})}\nc.innerHTML=h+'<p class=\"text-muted small mt-3\">v2.0 | Fleet Cost Optimizer</p>'}\n</script></body></html>\n"}}